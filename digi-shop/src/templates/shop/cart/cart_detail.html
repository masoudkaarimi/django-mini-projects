{% extends "_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Shopping Cart" %}{% endblock %}

{% block content %}
    <div class="container" data-authenticated="{{ is_authenticated|yesno:'true,false' }}">
        <div class="row my-5">
            <div class="col-12">
                <h1 class="mb-4">{% trans "Shopping Cart" %}</h1>

                <div class="cart-items-container">
                    {% if is_authenticated %}
                        {% if cart_data.items %}
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Product" %}</th>
                                            <th>{% trans "Price" %}</th>
                                            <th>{% trans "Quantity" %}</th>
                                            <th>{% trans "Subtotal" %}</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in cart_data.items %}
                                            <tr data-variant-id="{{ item.variant_id }}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        {% if item.image %}
                                                            <img src="{{ item.image.file.url }}" alt="{{ item.name }}" width="80" class="me-3">
                                                        {% else %}
                                                            <div class="product-placeholder me-3"></div>
                                                        {% endif %}
                                                        <div>
                                                            <h5><a href="{{ item.url }}">{{ item.name }}</a></h5>
                                                            <p class="text-muted mb-0">{{ item.variant_name }}</p>
                                                            {% if item.reserved_until %}
                                                                <small class="text-success">{% trans "Reserved until" %} {{ item.reserved_until|date:"H:i" }}</small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>${{ item.price }}</td>
                                                <td>
                                                    <div class="quantity-control d-flex align-items-center">
                                                        <button class="btn btn-sm btn-outline-secondary quantity-btn decrease" data-variant-id="{{ item.variant_id }}">-</button>
                                                        <input type="number" min="1" max="{{ item.stock }}" value="{{ item.quantity }}" class="form-control mx-2 quantity-input"
                                                               style="width: 60px;" data-variant-id="{{ item.variant_id }}">
                                                        <button class="btn btn-sm btn-outline-secondary quantity-btn increase" data-variant-id="{{ item.variant_id }}">+</button>
                                                    </div>
                                                </td>
                                                <td>${{ item.subtotal }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-danger remove-item" data-variant-id="{{ item.variant_id }}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>{% trans "Total:" %}</strong></td>
                                            <td><strong>${{ cart_data.total }}</strong></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-outline-danger clear-cart">{% trans "Clear Cart" %}</button>
                                <a href="{% url 'shop:checkout' %}" class="btn btn-primary">{% trans "Proceed to Checkout" %}</a>
                            </div>
                        {% else %}
                            <div class="empty-cart text-center py-5">
                                <i class="bi bi-cart3 display-1 text-muted mb-4"></i>
                                <h3>{% trans "Your cart is empty" %}</h3>
                                <p class="text-muted">{% trans "Add some products to your cart to continue shopping." %}</p>
                                <a href="{% url 'shop:product_list' %}" class="btn btn-primary mt-3">{% trans "Continue Shopping" %}</a>
                            </div>
                        {% endif %}
                    {% else %}
                        <!-- For guest users, cart will be populated via JavaScript -->
                        <div id="guest-cart-container">
                            <div class="loading-cart text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">{% trans "Loading your cart..." %}</p>
                            </div>
                        </div>

                        <template id="guest-cart-template">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Product" %}</th>
                                            <th>{% trans "Price" %}</th>
                                            <th>{% trans "Quantity" %}</th>
                                            <th>{% trans "Subtotal" %}</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="guest-cart-items">
                                        <!-- Items will be inserted here -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-end"><strong>{% trans "Total:" %}</strong></td>
                                            <td><strong id="guest-cart-total">$0.00</strong></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-outline-danger clear-cart">{% trans "Clear Cart" %}</button>
                                <a href="{% url 'account:login' %}?next={% url 'shop:checkout' %}" class="btn btn-primary">{% trans "Login to Checkout" %}</a>
                            </div>
                        </template>

                        <template id="empty-guest-cart-template">
                            <div class="empty-cart text-center py-5">
                                <i class="bi bi-cart3 display-1 text-muted mb-4"></i>
                                <h3>{% trans "Your cart is empty" %}</h3>
                                <p class="text-muted">{% trans "Add some products to your cart to continue shopping." %}</p>
                                <a href="{% url 'shop:product_list' %}" class="btn btn-primary mt-3">{% trans "Continue Shopping" %}</a>
                            </div>
                        </template>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/cart.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Handle cart functionality
            const cartManager = window.cartManager;

            // For authenticated users, handle quantity changes
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const variantId = this.dataset.variantId;
                    const input = document.querySelector(`.quantity-input[data-variant-id="${variantId}"]`);
                    let value = parseInt(input.value);

                    if (this.classList.contains('decrease')) {
                        value = Math.max(1, value - 1);
                    } else {
                        value = Math.min(parseInt(input.max) || 99, value + 1);
                    }

                    input.value = value;

                    // Update cart
                    cartManager.updateItemQuantity(variantId, value);
                });
            });

            // Handle quantity input changes
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function () {
                    const variantId = this.dataset.variantId;
                    let value = parseInt(this.value);

                    // Validate value
                    if (isNaN(value) || value < 1) {
                        value = 1;
                    } else if (this.max && value > parseInt(this.max)) {
                        value = parseInt(this.max);
                    }

                    this.value = value;

                    // Update cart
                    cartManager.updateItemQuantity(variantId, value);
                });
            });

            // Handle remove item buttons
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function () {
                    const variantId = this.dataset.variantId;
                    cartManager.removeItem(variantId);
                });
            });

            // Handle clear cart button
            document.querySelector('.clear-cart')?.addEventListener('click', function () {
                if (confirm('{% trans "Are you sure you want to clear your cart?" %}')) {
                    cartManager.clearCart();
                }
            });

            // For guest users, populate cart from localStorage
            if (!document.body.dataset.authenticated || document.body.dataset.authenticated === 'false') {
                const guestCartContainer = document.getElementById('guest-cart-container');
                const cart = cartManager.getCart();

                if (cart.items.length > 0) {
                    // Use the template for non-empty cart
                    const template = document.getElementById('guest-cart-template');
                    guestCartContainer.innerHTML = template.innerHTML;

                    // Populate cart items
                    const itemsContainer = document.getElementById('guest-cart-items');
                    let totalPrice = 0;

                    // Fetch product details for each item
                    const fetchPromises = cart.items.map(item => {
                        return fetch(`/cart/check-inventory/${item.variantId}/?quantity=${item.quantity}`)
                            .then(response => {
                                if (!response.ok) throw new Error('Network response was not ok');
                                return response.json();
                            })
                            .then(data => {
                                return fetch(`/api/products/variant/${item.variantId}/`)
                                    .then(response => {
                                        if (!response.ok) throw new Error('Network response was not ok');
                                        return response.json();
                                    })
                                    .then(productData => {
                                        // Create row for this item
                                        const tr = document.createElement('tr');
                                        tr.dataset.variantId = item.variantId;

                                        const price = productData.price || 0;
                                        const subtotal = price * item.quantity;
                                        totalPrice += subtotal;

                                        tr.innerHTML = `
                                        <td>
                                            <div class="d-flex align-items-center">
                                                ${productData.image ? `<img src="${productData.image}" alt="${productData.name}" width="80" class="me-3">` : '<div class="product-placeholder me-3"></div>'}
                                                <div>
                                                    <h5><a href="${productData.url}">${productData.name}</a></h5>
                                                    <p class="text-muted mb-0">${productData.variant_name}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>$${price.toFixed(2)}</td>
                                        <td>
                                            <div class="quantity-control d-flex align-items-center">
                                                <button class="btn btn-sm btn-outline-secondary quantity-btn-guest decrease" data-variant-id="${item.variantId}">-</button>
                                                <input type="number" min="1" max="${data.available_quantity}" value="${item.quantity}" class="form-control mx-2 quantity-input-guest" style="width: 60px;" data-variant-id="${item.variantId}">
                                                <button class="btn btn-sm btn-outline-secondary quantity-btn-guest increase" data-variant-id="${item.variantId}">+</button>
                                            </div>
                                        </td>
                                        <td>$${subtotal.toFixed(2)}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger remove-item-guest" data-variant-id="${item.variantId}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    `;

                                        return tr;
                                    });
                            })
                            .catch(error => {
                                console.error('Error fetching product details:', error);
                                return null;
                            });
                    });

                    Promise.all(fetchPromises).then(rows => {
                        // Add all valid rows to the container
                        rows.filter(row => row !== null).forEach(row => {
                            itemsContainer.appendChild(row);
                        });

                        // Update total
                        document.getElementById('guest-cart-total').textContent = `$${totalPrice.toFixed(2)}`;

                        // Add event listeners for guest cart
                        document.querySelectorAll('.quantity-btn-guest').forEach(btn => {
                            btn.addEventListener('click', function () {
                                const variantId = this.dataset.variantId;
                                const input = document.querySelector(`.quantity-input-guest[data-variant-id="${variantId}"]`);
                                let value = parseInt(input.value);

                                if (this.classList.contains('decrease')) {
                                    value = Math.max(1, value - 1);
                                } else {
                                    value = Math.min(parseInt(input.max) || 99, value + 1);
                                }

                                input.value = value;

                                // Update cart
                                cartManager.updateItemQuantity(variantId, value);
                            });
                        });

                        document.querySelectorAll('.quantity-input-guest').forEach(input => {
                            input.addEventListener('change', function () {
                                const variantId = this.dataset.variantId;
                                let value = parseInt(this.value);

                                // Validate value
                                if (isNaN(value) || value < 1) {
                                    value = 1;
                                } else if (this.max && value > parseInt(this.max)) {
                                    value = parseInt(this.max);
                                }

                                this.value = value;

                                // Update cart
                                cartManager.updateItemQuantity(variantId, value);
                            });
                        });

                        document.querySelectorAll('.remove-item-guest').forEach(btn => {
                            btn.addEventListener('click', function () {
                                const variantId = this.dataset.variantId;
                                cartManager.removeItem(variantId);

                                // Remove row
                                const row = document.querySelector(`tr[data-variant-id="${variantId}"]`);
                                row.remove();

                                // If no items left, show empty cart
                                if (document.querySelectorAll('#guest-cart-items tr').length === 0) {
                                    const emptyTemplate = document.getElementById('empty-guest-cart-template');
                                    guestCartContainer.innerHTML = emptyTemplate.innerHTML;
                                }
                            });
                        });
                    });
                } else {
                    // Use the empty cart template
                    const template = document.getElementById('empty-guest-cart-template');
                    guestCartContainer.innerHTML = template.innerHTML;
                }
            }
        });
    </script>
{% endblock %}